@using UniversalReportCore.Helpers
@using UniversalReportCore.Ui.ViewModels
@model SearchViewModel

<div class="collapse p-3" id="collapseSearch">

    @if (Model == null || Model.ReportColumns == null || !Model.ReportColumns.Any())
    {
        <p>No columns available for search.</p>
        return;
    }

    <form method="get">

        <!-- Preserve Other Query Parameters -->
        <input type="hidden" name="slug" value="@Model.Params?.Slug.Value" />
        <input type="hidden" name="ipp" value="@Model.Params?.Ipp.Value" />
        <input type="hidden" name="sortOrder" value="@Model.CurrentSort" />
        <input type="hidden" name="pi" value="@Model.Params?.Pi.Value" />

        @if (Model.Params?.CohortIds.Value != null)
        {
            @foreach (var cohortId in Model.Params.CohortIds.Value)
            {
                <input type="hidden" name="cohortIds" value="@cohortId" />
            }
        }

        @foreach (var column in Model.ReportColumns.Where(a => a.PropertyName != null && a.IsSearchable))
        {
            // Only strings are searchable.  Check sure if the underlying property is a string
            // TODO: Consider adding support other types like int, DateTime, etc.
            var property = Model.EntityViewModelType != null && column.PropertyName != null ? Model.EntityViewModelType.GetProperty(column.PropertyName) : null;
            if(property == null)
            {
                property = Model.EntityViewModelType != null && column.ViewModelPropertyName != null ? Model.EntityViewModelType.GetProperty(column.ViewModelPropertyName) : null;
            }
            if (property == null || property.PropertyType != typeof(string))
            {
                continue; // Skip non-string properties
            }

            KeyValuePair<string, string>? search = null;
            @if (Model.Params?.SearchQueries.Value != null)
            {
                search = Model.Params.SearchQueries.Value.FirstOrDefault(a => a.Key == column.PropertyName);
            }

            <div class="form-group my-1">
                <label style="width: 200px;" for=@($"query{column.PropertyName}")>@($"{StringHelper.SplitPascalCase(column.PropertyName ?? string.Empty)}")</label>
                <input type="text" id=@($"query{column.PropertyName}") name=@($"query{column.PropertyName}") style="width: 200px;" value=@(search?.Value) />
            </div>

        }

        @if(Model.Params != null)
        {
            @if (Model.Params.FilterKeys.Value != null)
            {
                @foreach (var filterKey in Model.Params.FilterKeys.Value)
                {
                    <input type="hidden" name="filters" value="@filterKey" />
                }
            }
        }

        <span class="d-inline-flex align-items-center my-2" role="toolbar" aria-label="Action Well Toolbar">
            <span class="btn-group btn-group-sm" role="group" aria-label="Action Well Group 1">
                <button type="submit" class="btn btn-primary d-flex align-items-center">
                    @Html.Raw(Model.ApplySearchButtonHtml)
                </button>
            </span>
        </span>

    </form>
</div>

